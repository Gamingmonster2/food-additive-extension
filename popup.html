<!--
manifest.json content:
{
  "manifest_version": 3,
  "name": "ÙƒØ§Ø´Ù Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© - Food Safety",
  "version": "1.0",
  "description": "ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø£ØºØ°ÙŠØ© Ù„Ù…Ø¹Ø±ÙØ© Ø£Ø¶Ø±Ø§Ø±Ù‡Ø§ ÙˆØ­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©",
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "icon.png",
      "48": "icon.png",
      "128": "icon.png"
    }
  },
  "permissions": ["camera", "tabs"]
}
-->

<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§Ø­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„ØºØ°Ø§Ø¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            width: 380px;
            height: auto;
        }
        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header Section -->
    <div class="bg-gradient-to-l from-green-600 to-emerald-500 p-5 text-white shadow-lg rounded-b-3xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://img.freepik.com/free-photo/fresh-vegetables-fruits-background_1339-666.jpg')] bg-cover"></div>
        <div class="relative z-10 text-center">
            <h1 class="text-2xl font-bold mb-1">ÙØ§Ø­Øµ Ø§Ù„ØºØ°Ø§Ø¡ Ø§Ù„Ø¢Ù…Ù†</h1>
            <p class="text-xs text-green-100 opacity-90">Ø§ÙØ­Øµ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§ØªØŒ Ø§Ø­Ù…Ù ØµØ­ØªÙƒ</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="p-5">
        
        <!-- Camera Section -->
        <button id="startScan" class="w-full mb-4 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-md">
            <span class="text-xl">ğŸ“·</span> ÙØªØ­ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
        </button>
        <div id="reader" class="hidden mb-4 rounded-xl overflow-hidden border-2 border-green-500 bg-black"></div>

        <!-- Search Input -->
        <div class="mb-6">
            <label for="additiveInput" class="block text-sm font-semibold text-gray-700 mb-2">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø© (E-Number) Ø£Ùˆ Ø§Ø³Ù…Ù‡Ø§:</label>
            <div class="relative">
                <input type="text" id="additiveInput" placeholder="Ù…Ø«Ø§Ù„: E171, E250, Aspartame..." 
                    class="w-full p-3 pr-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-green-500 transition-colors text-sm shadow-sm">
                <button id="searchBtn" class="absolute left-2 top-2 bottom-2 bg-green-600 hover:bg-green-700 text-white px-4 rounded-lg text-sm font-bold transition-transform active:scale-95">
                    ÙØ­Øµ
                </button>
            </div>
        </div>

        <!-- Results Area -->
        <div id="resultArea" class="hidden animate-fade-in-up">
            
            <!-- Result Card -->
            <div id="resultCard" class="bg-white border border-gray-100 rounded-xl shadow-md p-4 mb-4">
                <div class="flex items-center gap-3 mb-3 border-b pb-3 border-gray-100">
                    <div id="statusIcon" class="w-10 h-10 rounded-full flex items-center justify-center text-xl">
                        <!-- JS will inject icon here -->
                    </div>
                    <div>
                        <h3 id="additiveName" class="font-bold text-lg text-gray-900">--</h3>
                        <span id="riskLevel" class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-100 text-gray-600">--</span>
                    </div>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex gap-2">
                        <span class="font-bold text-gray-700 min-w-[70px]">Ø§Ù„ØªØµÙ†ÙŠÙ:</span>
                        <p id="categoryText" class="text-gray-600">--</p>
                    </div>
                    <div class="flex gap-2">
                        <span class="font-bold text-gray-700 min-w-[70px]">Ø§Ù„Ø£Ø¶Ø±Ø§Ø±:</span>
                        <p id="harmText" class="text-gray-600 leading-relaxed">--</p>
                    </div>
                    <div class="flex gap-2">
                        <span class="font-bold text-gray-700 min-w-[70px]">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                        <p id="statusText" class="text-gray-600">--</p>
                    </div>
                </div>
            </div>

            <!-- Google Link Button -->
            <a id="googleLink" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full py-2.5 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg text-sm font-semibold transition-colors border border-blue-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯ ÙÙŠ Ø¨Ø­Ø« Google
            </a>
        </div>

        <!-- Not Found State -->
        <div id="notFoundState" class="hidden text-center p-4 bg-yellow-50 rounded-xl border border-yellow-100">
            <p class="text-yellow-800 text-sm mb-3">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.</p>
            <a id="googleFallback" href="#" target="_blank" class="block w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-sm font-bold transition-colors shadow-sm">
                Ø¨Ø­Ø« ÙÙŠ Google Ø¹Ù† Ø§Ù„Ø£Ø¶Ø±Ø§Ø±
            </a>
        </div>

    </div>

    <!-- Footer -->
    <div class="bg-gray-100 p-3 text-center text-[10px] text-gray-500 border-t">
        ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø§Ø³ØªØ±Ø´Ø§Ø¯ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ©.
    </div>

    <script>
        // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØºØ±Ø© Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø·Ø±Ø© ÙˆØ§Ù„Ù…Ø«ÙŠØ±Ø© Ù„Ù„Ø¬Ø¯Ù„
        const additivesDB = {
            "E102": {
                name: "Tartrazine (E102)",
                risk: "high",
                category: "Ø£Ù„ÙˆØ§Ù† ØµÙ†Ø§Ø¹ÙŠØ©",
                harm: "Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ ÙØ±Ø· Ø§Ù„Ù†Ø´Ø§Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø·ÙØ§Ù„ØŒ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©ØŒ ÙˆØ§Ù„Ø±Ø¨Ùˆ. Ù…Ø­Ø¸ÙˆØ± ÙÙŠ Ø§Ù„Ù†Ø±ÙˆÙŠØ¬ ÙˆØ§Ù„Ù†Ù…Ø³Ø§.",
                status: "Ù…Ø«ÙŠØ± Ù„Ù„Ø¬Ø¯Ù„ / Ù…Ø­Ø¸ÙˆØ± ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø¯ÙˆÙ„"
            },
            "E171": {
                name: "Titanium Dioxide (E171)",
                risk: "high",
                category: "Ù…Ù„ÙˆÙ†Ø§Øª (Ù…Ø¨ÙŠØ¶)",
                harm: "ÙŠØµÙ†Ù ÙƒÙ…Ø§Ø¯Ø© Ù…Ø³Ø±Ø·Ù†Ø© Ù…Ø­ØªÙ…Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ†Ø´Ø§Ù‚. ØªÙ… Ø­Ø¸Ø±Ù‡ ÙÙŠ Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ ÙÙŠ Ø§Ù„Ø£ØºØ°ÙŠØ©.",
                status: "Ù…Ù…Ù†ÙˆØ¹ ÙÙŠ Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ"
            },
            "E250": {
                name: "Sodium Nitrite (E250)",
                risk: "high",
                category: "Ù…ÙˆØ§Ø¯ Ø­Ø§ÙØ¸Ø© (Ø§Ù„Ù„Ø­ÙˆÙ…)",
                harm: "Ø¹Ù†Ø¯ ØªØ¹Ø±Ø¶Ù‡Ø§ Ù„Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ù‚Ø¯ ØªØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ù†ÙŠØªØ±ÙˆØ²Ø§Ù…ÙŠÙ† ÙˆÙ‡ÙŠ Ù…ÙˆØ§Ø¯ Ù…Ø³Ø±Ø·Ù†Ø©.",
                status: "Ø®Ø·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ø·ÙˆÙŠÙ„"
            },
            "E951": {
                name: "Aspartame (E951)",
                risk: "medium",
                category: "Ù…Ø­Ù„ÙŠØ§Øª ØµÙ†Ø§Ø¹ÙŠØ©",
                harm: "Ø¬Ø¯Ù„ ÙˆØ§Ø³Ø¹ Ø­ÙˆÙ„ ØªØ³Ø¨Ø¨Ù‡ Ø¨Ø§Ù„ØµØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø±Ø·Ø§Ù†. ØµÙ†ÙØªÙ‡ Ù…Ù†Ø¸Ù…Ø© Ø§Ù„ØµØ­Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù…Ø¤Ø®Ø±Ø§Ù‹ ÙƒÙ…Ø³Ø±Ø·Ù† Ù…Ø­ØªÙ…Ù„ (Group 2B).",
                status: "ØªØ­Ø°ÙŠØ± ØµØ­ÙŠ"
            },
            "E621": {
                name: "Monosodium Glutamate (MSG)",
                risk: "medium",
                category: "Ù…Ø¹Ø²Ø²Ø§Øª Ù†ÙƒÙ‡Ø©",
                harm: "Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ø§Ù„ØµØ¯Ø§Ø¹ØŒ Ø§Ù„ØºØ«ÙŠØ§Ù†ØŒ ÙˆØªÙ†Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø±Ø§Ù (Ù…ØªÙ„Ø§Ø²Ù…Ø© Ø§Ù„Ù…Ø·Ø¹Ù… Ø§Ù„ØµÙŠÙ†ÙŠ) Ù„Ø¯Ù‰ Ø§Ù„Ø¨Ø¹Ø¶.",
                status: "Ø¢Ù…Ù† Ø¨Ø­Ø¯ÙˆØ¯"
            },
            "E924": {
                name: "Potassium Bromate",
                risk: "danger",
                category: "Ù…Ø­Ø³Ù†Ø§Øª Ø®Ø¨Ø²",
                harm: "Ù…Ø§Ø¯Ø© Ù…Ø³Ø±Ø·Ù†Ø© Ù…Ù† Ø§Ù„ÙØ¦Ø© 2B. ØªØ³Ø¨Ø¨ Ø£ÙˆØ±Ø§Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙ„Ù‰ ÙˆØ§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©.",
                status: "Ù…Ù…Ù†ÙˆØ¹ Ø¯ÙˆÙ„ÙŠØ§Ù‹ (Ø£ØºÙ„Ø¨ Ø§Ù„Ø¯ÙˆÙ„)"
            },
            "E300": {
                name: "Ascorbic Acid (Vitamin C)",
                risk: "safe",
                category: "Ù…Ø¶Ø§Ø¯ Ø£ÙƒØ³Ø¯Ø©",
                harm: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¶Ø±Ø§Ø± Ù…Ø¹Ø±ÙˆÙØ© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ. Ù…ÙÙŠØ¯ Ù„Ù„ØµØ­Ø©.",
                status: "Ø¢Ù…Ù† ØªÙ…Ø§Ù…Ø§Ù‹"
            }
        };

        const searchBtn = document.getElementById('searchBtn');
        const inputField = document.getElementById('additiveInput');
        const resultArea = document.getElementById('resultArea');
        const notFoundState = document.getElementById('notFoundState');

        // UI Elements
        const statusIcon = document.getElementById('statusIcon');
        const additiveName = document.getElementById('additiveName');
        const riskLevel = document.getElementById('riskLevel');
        const categoryText = document.getElementById('categoryText');
        const harmText = document.getElementById('harmText');
        const statusText = document.getElementById('statusText');
        const googleLink = document.getElementById('googleLink');
        const googleFallback = document.getElementById('googleFallback');

        // Camera Elements
        const startScanBtn = document.getElementById('startScan');
        const readerDiv = document.getElementById('reader');
        let html5QrcodeScanner = null;

        searchBtn.addEventListener('click', performCheck);
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performCheck();
        });

        // --- Camera Logic ---
        startScanBtn.addEventListener('click', () => {
            if (readerDiv.classList.contains('hidden')) {
                startCamera();
            } else {
                stopCamera();
            }
        });

        function startCamera() {
            readerDiv.classList.remove('hidden');
            startScanBtn.innerHTML = '<span class="text-xl">âŒ</span> Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
            startScanBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            startScanBtn.classList.add('bg-red-500', 'hover:bg-red-600');

            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                console.error("Error starting scanner", err);
                alert("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.");
                stopCamera();
            });
        }

        function stopCamera() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    resetCameraUI();
                }).catch(err => {
                    console.error("Failed to stop", err);
                    resetCameraUI();
                });
            } else {
                resetCameraUI();
            }
        }

        function resetCameraUI() {
            readerDiv.classList.add('hidden');
            startScanBtn.innerHTML = '<span class="text-xl">ğŸ“·</span> ÙØªØ­ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ';
            startScanBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            startScanBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            html5QrcodeScanner = null;
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Stop scanning upon success
            stopCamera();
            // Set value to input
            inputField.value = decodedText;
            // Trigger search automatically
            performCheck();
        }
        // --------------------

        function performCheck() {
            const query = inputField.value.trim().toUpperCase();
            
            if (!query) return;

            // Reset UI
            resultArea.classList.add('hidden');
            notFoundState.classList.add('hidden');

            // Direct Search Logic (Simulated Backend)
            let result = null;
            
            // Check by code (E102) or partial name check
            for (let key in additivesDB) {
                if (key === query || additivesDB[key].name.toUpperCase().includes(query)) {
                    result = additivesDB[key];
                    break;
                }
            }

            if (result) {
                showResult(result, query);
            } else {
                showNotFound(query);
            }
        }

        function showResult(data, query) {
            resultArea.classList.remove('hidden');
            
            additiveName.textContent = data.name;
            categoryText.textContent = data.category;
            harmText.textContent = data.harm;
            statusText.textContent = data.status;

            // Configure Risk Styling
            if (data.risk === 'high' || data.risk === 'danger') {
                statusIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center text-2xl bg-red-100 text-red-600';
                statusIcon.innerHTML = 'âš ï¸';
                riskLevel.className = 'text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700';
                riskLevel.textContent = 'Ø®Ø·Ø± / ØªØ­Ø°ÙŠØ±';
            } else if (data.risk === 'medium') {
                statusIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center text-2xl bg-yellow-100 text-yellow-600';
                statusIcon.innerHTML = 'âœ‹';
                riskLevel.className = 'text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-700';
                riskLevel.textContent = 'ØªÙ†Ø¨ÙŠÙ‡ Ù…ØªÙˆØ³Ø·';
            } else {
                statusIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center text-2xl bg-green-100 text-green-600';
                statusIcon.innerHTML = 'âœ…';
                riskLevel.className = 'text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700';
                riskLevel.textContent = 'Ø¢Ù…Ù†';
            }

            // Google Search Link construction
            const searchUrl = `https://www.google.com/search?q=${query}+food+additive+side+effects+cancer+warnings`;
            googleLink.href = searchUrl;
        }

        function showNotFound(query) {
            notFoundState.classList.remove('hidden');
            // Create a smart search query for Google
            const searchUrl = `https://www.google.com/search?q=Is+${query}+harmful+food+additive+banned`;
            googleFallback.href = searchUrl;
        }
    </script>
</body>
</html>
